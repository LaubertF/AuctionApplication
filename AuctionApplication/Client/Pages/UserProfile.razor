@page "/profile"
@using AuctionApplication.Shared
@using System.Text.Json
@using System.Text.Json.Serialization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication

@inject NavigationManager Navigation
@inject SignOutSessionStateManager SignOutManager
@attribute [Authorize]
@inject HttpClient Http

<h3 class="fw-bold mb-4">Your profile</h3>
<div class="container">
    <div class="row g-5">
        <div class="col-12 col-lg-4">
            <div class="card shadow">
                <div class="card-body">
                    <h5 class="card-title fw-bold mb-4">User information</h5>
                    <label for="firstName">First name</label>
                    <input type="text" class="form-control" id="firstName" placeholder="First name" value="Name" required>
                    <label for="lastName">Last name</label>
                    <input type="text" class="form-control" id="lastName" placeholder="Last name" value="Surname" required>
                    <label for="email">Email</label>
                    <input type="text" class="form-control" id="email" placeholder="Email" value="Email" required>
                </div>
                <div class="card-footer d-flex justify-content-center">
                    <button class="btn-sm btn-outline-primary ms-2" type="submit">Submit</button>
                </div>
            </div>
        </div>
        <div class="col-12 col-lg-8">
            <div class="card shadow card-scale-sm">
                <div class="card-body">
                    <h5 class="card-title fw-bold mb-4">Auctions won</h5>
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th scope="col">Auction</th>
                                <th scope="col">Price</th>
                                <th scope="col">Status</th>
                                <th scope="col">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                        @if (auctions != null)
                        {
                            @foreach (var auction in auctions)
                            {
                                <tr>
                                    <td><a class="link-dark" href="/auction/detail/@auction.Id">@auction.NameOfProduct</a></td>
                                    <td>@auction.StartingPrice</td>
                                    <td>Not Paid</td>
                                    <td><a class="btn btn-sm btn-warning button-round ms-2" type="submit" href="/auction/detail/@auction.Id/payment">Pay</a></td>
                                </tr>
                            }
                        }
                        else
                        {
                            <h6 class="mb-4">You haven't won anything yet!</h6>
                        }
                        
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
    </div>
</div>


@code {
    private IList<AuctionApplication.Shared.Auction>? auctions;
    
    protected override async Task OnInitializedAsync()
    {
        try
        {
            var response = await Http.GetAsync("/User/Wins");
            if (response.IsSuccessStatusCode)
            {
                var contentStream = await response.Content.ReadAsStreamAsync();
                
                var rawContent = await response.Content.ReadAsStringAsync();
                Console.WriteLine(rawContent);
                
                auctions = await JsonSerializer.DeserializeAsync<IList<AuctionApplication.Shared.Auction>>(contentStream, new JsonSerializerOptions
                {
                    PropertyNameCaseInsensitive = true, // Make property names case-insensitive
                    Converters = { new JsonStringEnumConverter() } // Handle enum serialization/deserialization
                });
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine("CATCH");
            Console.WriteLine(ex);
        }
    }

    
}
